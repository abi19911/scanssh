#!/bin/bash

### Functions
# Loading text animation
show_loading() {
  mypid=$!
  loadingText=$1
  echo -ne "$loadingText\r"
  while kill -0 $mypid 2>/dev/null; do
    echo -ne "$loadingText.\r"
    sleep 0.5
    echo -ne "$loadingText..\r"
    sleep 0.5
    echo -ne "$loadingText...\r"
    sleep 0.5
    echo -ne "\r\033[K"
    echo -ne "$loadingText\r"
    sleep 0.5
  done
  echo -ne "\r\033[K"
}

# Interactive dialog menu
dialog_menu() {
arr="$(dialog --no-items --clear \
--backtitle "$1" \
--title "$2" \
--menu "$3" 15 35 3 \
"${!4}" --output-fd 1)"
}

# Get host IPs from active network cards
local_ip() {
  localip=($(ip -o -f inet addr show | awk '/scope global/ {print $4}'))
  [ -z ${localip[@]} ] && echo "No subnet detected, are you connected?" && exit 1 || echo "Local subnets found: ${localip[@]}"
}

# Finds IPs in local network
scan_ip() {
  rm $temp 2> /dev/null

  # Use fping to look for active hosts in network
  for subnet in ${localip[@]}; do
    fping -ag $subnet 2>/dev/null | tr '\r\n' ' ' >>$temp
  done & show_loading "Scanning for IPs in local network" > /dev/tty
  echo "" >>$temp

  # Delete host ip from tmp file
  for host in ${localip[@]}; do
    hostip=`echo $host | cut -f1 -d"/"`
    sed -i "s/${hostip} //g" $temp
  done

  # Use nmap to scan all active hosts for port 22
  fping_ip=($(awk 'NR==1' $temp))
  for fil_ip in ${fping_ip[@]}; do
    if [[ $(nmap -p22 $fil_ip | grep "open") ]]; then
      echo $fil_ip
    fi
  done | tr '\r\n' ' ' >>$temp & show_loading "Looking for open ssh ports in local network" > /dev/tty
  run
}

# Main script
run() {
  # Read line 2 of temp file
  nmap_ip=($(awk 'NR==2' $temp))
  [ -z "$nmap_ip" ] && echo "No IPs found in local network" && exit 1

  # Create interative dialog menu for detected IPs and run ssh command
  dialog_menu "scanssh" "scanssh" "Select an IP to connect to:" nmap_ip[@]
  [ -z "$arr" ] && clear && exit 0
  clear
  read -p "Enter username for $arr: " username 2> /dev/tty
  ssh $username@$arr 2> /dev/tty
  exit 0
} 2> /dev/null

# Looks for tmp folder (termux support)
[ -d "/tmp/" ] && temp="/tmp/scanssh"
[ -d "/data/data/com.termux/files/usr/tmp" ] && temp="/data/data/com.termux/files/usr/tmp/scanssh"

# Runs script directly if no arguments is passed
if [ $# -eq 0 ]; then
  if [ -f $temp ]; then
    local_ip
    run
  else
    local_ip
    scan_ip
  fi
fi

# Runs script with arguments
while getopts "rdh" opt; do
  case ${opt} in
    r)
      local_ip
      scan_ip
      ;;
    d)
      rm $temp 2> /dev/null && echo "Deleted IP list" || echo "IP list already empty"
      ;;
    h|?)
      cat << EOM
Running scanssh without any arguments; it will look for cached local IPs in tmp file and
run the script using that data. If tmp file doesn't exist, the script will scan for local IPs and create one.

Usage: scanssh <no arguments>
         \____ [-r] refresh IP list
          \___ [-d] delete IP list
           \__ [-h] help menu
EOM
      exit 0
      ;;
  esac
done
